<div class="add-activity-container">
    <h2>Add Activity</h2>
    <form action="/manage-activity/add" method="POST" id="activity-form">
  
      <label for="title">Activity Title:</label>
      <input type="text" name="title" required>
  
      <label for="provider_name">Provider Name:</label>
      <input type="text" name="provider_name" required>
  
      <label for="website">Provider Website:</label>
      <input class="smaller" type="url" name="website">
  
      <label for="contact_email">Contact Email:</label>
      <input class="smaller" type="email" name="contact_email">
  
      <label for="description">Description:</label>
      <textarea name="description" required></textarea>
  
      <!-- Dropdown for Day of the Week -->
      <label for="day">Day of Week:</label>
      <select name="day" required>
        <option value="">Select</option>
        <option value="Monday">Monday</option>
        <option value="Tuesday">Tuesday</option>
        <option value="Wednesday">Wednesday</option>
        <option value="Thursday">Thursday</option>
        <option value="Friday">Friday</option>
        <option value="Saturday">Saturday</option>
        <option value="Sunday">Sunday</option>
      </select>

      <label for="times">Time:</label>
      <div class="time-container">
        <select name="start_time" id="start_time" required>
          <option value="">Start</option>
        </select>
        <span> to </span>
        <select name="stop_time" id="stop_time" required>
          <option value="">Finish</option>
        </select>
      </div>
  
      <!-- Dropdown for Target Group -->
      <label for="target_group">Target Group:</label>
      <select name="target_group" required>
        <option value="">Select</option>
        <option value="Children">Children</option>
        <option value="Youth">Youth</option>
        <option value="Adults">Adults</option>
        <option value="Everyone">Everyone</option>
        <option value="Families">Families</option>
        <option value="Other">Other</option>
      </select>
  
      <label for="age_range">Age Range:</label>
      <div class="age-range-container">
        <select name="age_start" id="age_start" required>
          <option value="">From</option>
        </select>
        <span> to </span>
        <select name="age_end" id="age_end" required>
          <option value="">To</option>
        </select>
      </div>

      <!-- Hidden input to store final joined age range -->
      <input type="hidden" name="age_range" id="age_range">
  
      <!-- Dropdown for Total Spaces -->
      <label for="total_spaces">Total Spaces:</label>
      <select name="total_spaces" id="total_spaces" required>
        <option value="">Select</option>
      </select>
  
      <!-- Dropdown for Spaces Remaining -->
      <label for="spaces_remaining">Spaces Remaining:</label>
      <select name="spaces_remaining" id="spaces_remaining" required>
        <option value="">Select</option>
      </select>
  
      <label for="cost">Cost(£):</label>
      <input class="even-smaller" type="text" name="cost" id="cost" required placeholder="0.00">
  
      <h3>Address Details</h3>
      <label for="street_1">Street Address / Building Name:</label>
      <input type="text" name="street_1" required>
  
      <label for="street_2">Street Address 2:</label>
      <input type="text" name="street_2">
  
      <label for="city">City:</label>
      <input class="smaller" type="text" name="city" required>
  
      <label for="postcode">Postcode:</label>
      <input class="even-smaller" type="text" name="postcode" id="postcode" required>
  
      <button type="submit">Add Activity</button>
    </form>
</div>

<script>

  document.addEventListener("DOMContentLoaded", function () {
    const totalSpacesDropdown = document.getElementById("total_spaces");
    const spacesRemainingDropdown = document.getElementById("spaces_remaining");
    const ageStartDropdown = document.getElementById("age_start");
    const ageEndDropdown = document.getElementById("age_end");
    const ageRangeInput = document.getElementById("age_range");
    const costInput = document.getElementById("cost");
    const postcodeInput = document.getElementById("postcode");
    const startTimeDropdown = document.getElementById("start_time");
    const stopTimeDropdown = document.getElementById("stop_time");
    const form = document.getElementById("activity-form");
  
    /** Populate total spaces dropdown (1 to 100) */
    for (let i = 1; i <= 100; i++) {
      totalSpacesDropdown.appendChild(new Option(i, i));
    }
  
    /** Update spaces remaining dropdown dynamically */
    function updateSpacesRemaining() {
      spacesRemainingDropdown.innerHTML = '<option value="">Select</option>';
      const totalSpaces = parseInt(totalSpacesDropdown.value, 10);
      if (!isNaN(totalSpaces)) {
        for (let i = 0; i <= totalSpaces; i++) {
          spacesRemainingDropdown.appendChild(new Option(i, i));
        }
      }
    }
    totalSpacesDropdown.addEventListener("change", updateSpacesRemaining);
  
    /** Populate age dropdowns (0 to 30) */
    function populateAgeDropdowns() {
      for (let i = 0; i <= 30; i++) {
        ageStartDropdown.appendChild(new Option(i, i));
        ageEndDropdown.appendChild(new Option(i, i));
      }
    }
    populateAgeDropdowns();

    /** Generate times from 06:00 to 22:00 in 15-minute intervals */
    function generateTimeOptions() {
      const times = [];
      for (let hour = 6; hour <= 22; hour++) {
        for (let minutes of ["00", "05", "10", "15", "20", "25", "30", "35", "45", "50", "55"]) {
          if (hour === 22 && minutes !== "00") break; // Ensure last time is 22:00
          times.push(`${hour.toString().padStart(2, "0")}:${minutes}`);
        }
      }
      return times;
    }

    /** Populate start time dropdown */
    const timeOptions = generateTimeOptions();
    timeOptions.forEach(time => {
      startTimeDropdown.appendChild(new Option(time, time));
    });

    /** Update stop time options based on selected start time */
    startTimeDropdown.addEventListener("change", function () {
      stopTimeDropdown.innerHTML = '<option value="">Finish</option>'; // Reset stop time options
      const selectedStartTime = startTimeDropdown.value;

      if (!selectedStartTime) return;

      // Only add times that are later than the selected start time
      timeOptions.forEach(time => {
        if (time > selectedStartTime) {
          stopTimeDropdown.appendChild(new Option(time, time));
        }
      });
    });
  
    /** Dynamically update end age options based on start age selection */
    ageStartDropdown.addEventListener("change", function () {
      const startAge = parseInt(ageStartDropdown.value, 10);
      ageEndDropdown.innerHTML = ""; // Clear existing options
    
      for (let i = startAge; i <= 30; i++) {
        ageEndDropdown.appendChild(new Option(i, i));
      }
    });
  
    /** Ensure start age is not greater than end age */
    function validateAgeRange() {
      const startAge = parseInt(ageStartDropdown.value, 10);
      const endAge = parseInt(ageEndDropdown.value, 10);
      if (startAge > endAge) {
        alert("Start age cannot be greater than end age.");
        return false;
      }
      return true;
    }
  
    /** Enforce valid number format in cost input */
    costInput.addEventListener("input", function () {
      this.value = this.value
        .replace(/[^0-9.]/g, "") // Remove invalid characters
        .replace(/(\..*?)\..*/g, "$1") // Ensure only one decimal
        .replace(/^(\d*\.\d{2}).*$/, "$1"); // Limit to 2 decimal places
    });
  
    /** Auto-uppercase and format UK postcode */
    postcodeInput.addEventListener("input", function () {
      let formattedPostcode = this.value.toUpperCase().trim();
    
      // Automatically insert space if missing (e.g., SW1A1AA → SW1A 1AA)
      const formatted = formattedPostcode.replace(/^([A-Z]{1,2}\d[A-Z\d]?) ?(\d[A-Z]{2})$/, "$1 $2");
    
      this.value = formatted;
      validatePostcode(formatted);
    });

    /** Ensure start time is not greater than stop time */
    function validateTimeRange() {
      const startTime = startTimeDropdown.value;
      const stopTime = stopTimeDropdown.value;

      if (startTime && stopTime && stopTime <= startTime) {
        alert("Finish time must be later than start time.");
        return false;
      }
      return true;
    }
  
    /** ✅ Check postcode validity using Postcodes.io API */
    async function validatePostcode(postcode) {
      const cleanPostcode = postcode.replace(/\s+/g, "").toUpperCase(); // Remove spaces for API request
      if (cleanPostcode.length < 5) {
        postcodeInput.style.border = "2px solid red";
        return;
      }
    
      try {
        const response = await fetch(`https://api.postcodes.io/postcodes/${cleanPostcode}/validate`);
        const data = await response.json();
        
        if (data.result) {
          postcodeInput.style.border = "2px solid green"; // ✅ Valid
        } else {
          postcodeInput.style.border = "2px solid red"; // ❌ Invalid
        }
      } catch (error) {
        console.error("Error checking postcode:", error);
        postcodeInput.style.border = "2px solid red"; // ❌ Assume invalid on API failure
      }
    }
  
    /** ✅ Form Submission: Validate before submitting */
    form.addEventListener("submit", async function (event) {
      event.preventDefault(); // Stop form submission until validation is complete
    
      const totalSpaces = parseInt(totalSpacesDropdown.value, 10);
      const spacesRemaining = parseInt(spacesRemainingDropdown.value, 10);
      const costValue = costInput.value.trim();
      const postcodeValue = postcodeInput.value.trim();
      const costRegex = /^\d+(\.\d{1,2})?$/;
    
      if (!validateTimeRange()) return;

      if (!validateAgeRange()) return;
      
      if (spacesRemaining > totalSpaces) {
        alert("Spaces remaining cannot be greater than total spaces.");
        return;
      }
    
      if (!costRegex.test(costValue)) {
        alert("Please enter a valid cost (e.g., 10 or 10.50).");
        return;
      }
    
      // Final API validation before submission
      const isValid = await fetch(`https://api.postcodes.io/postcodes/${postcodeValue.replace(/\s+/g, "").toUpperCase()}/validate`)
        .then(res => res.json())
        .then(data => data.result)
        .catch(() => false);
    
      if (!isValid) {
        alert("Invalid UK postcode. Please check and try again.");
        return;
      }
    
      // Save formatted age range
      ageRangeInput.value = `${ageStartDropdown.value}-${ageEndDropdown.value}`;
    
      // ✅ If everything is valid, submit the form
      form.submit();
    });
  });

</script>
  